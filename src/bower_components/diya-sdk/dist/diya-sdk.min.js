!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.diya=e()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports="function"==typeof Object.create?function(ctor,superCtor){ctor.super_=superCtor,ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:!1,writable:!0,configurable:!0}})}:function(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype,ctor.prototype=new TempCtor,ctor.prototype.constructor=ctor}},{}],2:[function(require,module,exports){function noop(){}var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];return window.addEventListener("message",function(ev){var source=ev.source;if((source===window||null===source)&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")}},{}],3:[function(require,module,exports){module.exports=function(arg){return arg&&"object"==typeof arg&&"function"==typeof arg.copy&&"function"==typeof arg.fill&&"function"==typeof arg.readUInt8}},{}],4:[function(require,module,exports){(function(process,global){function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};return arguments.length>=3&&(ctx.depth=arguments[2]),arguments.length>=4&&(ctx.colors=arguments[3]),isBoolean(opts)?ctx.showHidden=opts:opts&&exports._extend(ctx,opts),isUndefined(ctx.showHidden)&&(ctx.showHidden=!1),isUndefined(ctx.depth)&&(ctx.depth=2),isUndefined(ctx.colors)&&(ctx.colors=!1),isUndefined(ctx.customInspect)&&(ctx.customInspect=!0),ctx.colors&&(ctx.stylize=stylizeWithColor),formatValue(ctx,obj,ctx.depth)}function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];return style?"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m":str}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};return array.forEach(function(val,idx){hash[val]=!0}),hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&(!value.constructor||value.constructor.prototype!==value)){var ret=value.inspect(recurseTimes,ctx);return isString(ret)||(ret=formatValue(ctx,ret,recurseTimes)),ret}var primitive=formatPrimitive(ctx,value);if(primitive)return primitive;var keys=Object.keys(value),visibleKeys=arrayToHash(keys);if(ctx.showHidden&&(keys=Object.getOwnPropertyNames(value)),isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0))return formatError(value);if(0===keys.length){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value))return ctx.stylize(RegExp.prototype.toString.call(value),"regexp");if(isDate(value))return ctx.stylize(Date.prototype.toString.call(value),"date");if(isError(value))return formatError(value)}var base="",array=!1,braces=["{","}"];if(isArray(value)&&(array=!0,braces=["[","]"]),isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)&&(base=" "+RegExp.prototype.toString.call(value)),isDate(value)&&(base=" "+Date.prototype.toUTCString.call(value)),isError(value)&&(base=" "+formatError(value)),0===keys.length&&(!array||0==value.length))return braces[0]+base+braces[1];if(0>recurseTimes)return isRegExp(value)?ctx.stylize(RegExp.prototype.toString.call(value),"regexp"):ctx.stylize("[Object]","special");ctx.seen.push(value);var output;return output=array?formatArray(ctx,value,recurseTimes,visibleKeys,keys):keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)}),ctx.seen.pop(),reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}return isNumber(value)?ctx.stylize(""+value,"number"):isBoolean(value)?ctx.stylize(""+value,"boolean"):isNull(value)?ctx.stylize("null","null"):void 0}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){for(var output=[],i=0,l=value.length;l>i;++i)output.push(hasOwnProperty(value,String(i))?formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),!0):"");return keys.forEach(function(key){key.match(/^\d+$/)||output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,!0))}),output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;if(desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]},desc.get?str=desc.set?ctx.stylize("[Getter/Setter]","special"):ctx.stylize("[Getter]","special"):desc.set&&(str=ctx.stylize("[Setter]","special")),hasOwnProperty(visibleKeys,key)||(name="["+key+"]"),str||(ctx.seen.indexOf(desc.value)<0?(str=isNull(recurseTimes)?formatValue(ctx,desc.value,null):formatValue(ctx,desc.value,recurseTimes-1),str.indexOf("\n")>-1&&(str=array?str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2):"\n"+str.split("\n").map(function(line){return"   "+line}).join("\n"))):str=ctx.stylize("[Circular]","special")),isUndefined(name)){if(array&&key.match(/^\d+$/))return str;name=JSON.stringify(""+key),name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)?(name=name.substr(1,name.length-2),name=ctx.stylize(name,"name")):(name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'"),name=ctx.stylize(name,"string"))}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0,length=output.reduce(function(prev,cur){return numLinesEst++,cur.indexOf("\n")>=0&&numLinesEst++,prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);return length>60?braces[0]+(""===base?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]:braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}function isBoolean(arg){return"boolean"==typeof arg}function isNull(arg){return null===arg}function isNullOrUndefined(arg){return null==arg}function isNumber(arg){return"number"==typeof arg}function isString(arg){return"string"==typeof arg}function isSymbol(arg){return"symbol"==typeof arg}function isUndefined(arg){return void 0===arg}function isRegExp(re){return isObject(re)&&"[object RegExp]"===objectToString(re)}function isObject(arg){return"object"==typeof arg&&null!==arg}function isDate(d){return isObject(d)&&"[object Date]"===objectToString(d)}function isError(e){return isObject(e)&&("[object Error]"===objectToString(e)||e instanceof Error)}function isFunction(arg){return"function"==typeof arg}function isPrimitive(arg){return null===arg||"boolean"==typeof arg||"number"==typeof arg||"string"==typeof arg||"symbol"==typeof arg||"undefined"==typeof arg}function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return 10>n?"0"+n.toString(10):n.toString(10)}function timestamp(){var d=new Date,time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){for(var objects=[],i=0;i<arguments.length;i++)objects.push(inspect(arguments[i]));return objects.join(" ")}for(var i=1,args=arguments,len=args.length,str=String(f).replace(formatRegExp,function(x){if("%%"===x)return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}}),x=args[i];len>i;x=args[++i])str+=isNull(x)||!isObject(x)?" "+x:" "+inspect(x);return str},exports.deprecate=function(fn,msg){function deprecated(){if(!warned){if(process.throwDeprecation)throw new Error(msg);process.traceDeprecation?console.trace(msg):console.error(msg),warned=!0}return fn.apply(this,arguments)}if(isUndefined(global.process))return function(){return exports.deprecate(fn,msg).apply(this,arguments)};if(process.noDeprecation===!0)return fn;var warned=!1;return deprecated};var debugEnviron,debugs={};exports.debuglog=function(set){if(isUndefined(debugEnviron)&&(debugEnviron=process.env.NODE_DEBUG||""),set=set.toUpperCase(),!debugs[set])if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else debugs[set]=function(){};return debugs[set]},exports.inspect=inspect,inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]},inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"},exports.isArray=isArray,exports.isBoolean=isBoolean,exports.isNull=isNull,exports.isNullOrUndefined=isNullOrUndefined,exports.isNumber=isNumber,exports.isString=isString,exports.isSymbol=isSymbol,exports.isUndefined=isUndefined,exports.isRegExp=isRegExp,exports.isObject=isObject,exports.isDate=isDate,exports.isError=isError,exports.isFunction=isFunction,exports.isPrimitive=isPrimitive,exports.isBuffer=require("./support/isBuffer");var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))},exports.inherits=require("inherits"),exports._extend=function(origin,add){if(!add||!isObject(add))return origin;for(var keys=Object.keys(add),i=keys.length;i--;)origin[keys[i]]=add[keys[i]];return origin}}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./support/isBuffer":3,_process:2,inherits:1}],5:[function(require,module,exports){function Diya(addr){function consumeNextReqId(){return nextReqId++,nextReqId}function consumeNextSubscriptionId(){return nextSubscriptionId++,nextSubscriptionId}function dispatch(msg){if(void 0!==msg.reqId)dispatchRequest(msg);else{if(void 0===msg.subId)return console.log("missing reqId or subId. Ignoring msg : "),void console.log(msg);dispatchEvent(msg)}}function dispatchRequest(msg){return"function"!=typeof pendingRequests[msg.reqId]?void console.log("msg.reqId doesn't match any pending request, Ignoring msg ! "+msg):(console.log(msg),pendingRequests[msg.reqId](msg.data),delete pendingRequests[msg.reqId],void 0)}function dispatchEvent(msg){return"function"!=typeof registeredListeners[msg.subId]?(console.log("msg.subId doesn't match any registered listeners, Ignoring msg ! "),void console.log(msg)):(console.log(msg),void(msg.result&&"closed"==msg.result?(registeredListeners[msg.subId](null),delete registeredListeners[msg.subId]):registeredListeners[msg.subId](msg.data)))}function send(msg){(socket.readyState===WebSocket.CLOSING||socket.readyState===WebSocket.CLOSED)&&console.log("diya-SDK : cannot send message -> socket closed");try{data=JSON.stringify(msg),socket.send(data)}catch(e){console.log("malformed JSON, ignoring msg...")}}function handleMessage(incomingMessage){var msg;try{msg=JSON.parse(incomingMessage.data)}catch(e){return void console.log("malformed JSON")}dispatch(msg)}function closeAll(){for(;pendingRequests.length;)pendingRequests.pop();for(;registeredListeners.length;)registeredListeners.pop();"function"==typeof close_cb&&close_cb()}function createMessage(params){return params.service?{service:params.service,func:params.func?params.func:void 0,obj:params.obj?params.obj:void 0,data:params.data?params.data:void 0}:null}var socket,that=this,DEBUG=!1,close_cb=null,pendingRequests=[],registeredListeners=[],nextReqId=-1,nextSubscriptionId=-1;this.connect=function(callback,args){try{socket=new WebSocket(addr),socket.onerror=function(e){callback("Cannot Connect",null)},socket.onopen=function(){callback(null,args)},socket.onmessage=function(incomingMessage){handleMessage(incomingMessage)},socket.onclose=function(){closeAll()}}catch(e){console.log("can't connect to "+addr)}},this.get=function(params,callback,timeout){var msg=createMessage(params);null!==msg&&(msg.reqId=consumeNextReqId(),pendingRequests[msg.reqId]=callback,timeout&&timeout>0&&setTimeout(function(){pendingRequests[msg.reqId]&&delete pendingRequests[msg.reqId]},timeout),send(msg))},this.listen=function(params,callback,timeout){var msg=createMessage(params);if(null!==msg)return msg.subId=consumeNextSubscriptionId(),registeredListeners[msg.subId]=callback,timeout&&timeout>0&&setTimeout(function(){that.stopListening(msg.subId)},timeout),send(msg),msg.subId},this.closeCallback=function(cb){close_cb=cb},this.stopListening=function(subId){registeredListeners[subId]&&(msg={func:"Unsubscribe",data:{subId:subId}},send(msg),delete registeredListeners[subId])},this.connected=function(){return!(socket.readyState===WebSocket.CLOSING||socket.readyState===WebSocket.CLOSED)},this.disconnect=function(){socket.close(),closeAll()},this.debug=function(value){DEBUG=value}}function DiyaClient(addr,user,password){function createNode(){var node=new diya.Diya(addr);return node}this.setAddress=function(address){addr=address},this.createSession=function(onconnected,onfailure){var node=createNode();node.connect(function(err){err?onfailure(err):node.get({service:"auth",func:"Authenticate",data:{user:user,password:password}},function(res){res.authenticated||res.error&&"ServiceNotFound"===res.error?onconnected(node):onfailure()})})}}var rtc=(require("./services/message"),require("./services/rtc/rtc")),Promethe=require("./services/promethe/promethe"),discover=require("./services/discover/discover"),qei=require("./services/qei/qei"),update=require("./services/update/update"),WebSocket=window.WebSocket||window.MozWebSocket,diya={DiyaClient:DiyaClient,Diya:Diya,rtc:rtc,Promethe:Promethe,discover:discover,qei:qei,update:update};module.exports=diya},{"./services/discover/discover":6,"./services/message":7,"./services/promethe/promethe":8,"./services/qei/qei":9,"./services/rtc/rtc":10,"./services/update/update":11}],6:[function(require,module,exports){function isNode(){if(dgram)return!0;try{return dgram=require("dgram"),!0}catch(e){return!1}}function listen(callback){isNode()&&callbacks.push(callback)}function removeOutdatedDiyas(){for(var i=0;i<diyas.length;i++)(new Date).getTime()-diyas[i].touch>1e4&&diyas.splice(i,1)}function getDiya(name,port,address){for(var i=0;i<diyas.length;i++)if(diyas[i].name===name&&diyas[i].addr===address+":"+port)return diyas[i];return null}function gotDiya(name,port,address){var diya=getDiya(name,port,address);diya||(diya={name:name,addr:address+":"+port},diyas.push(diya)),diya.touch=(new Date).getTime()}function request(){socket.send(networkIdRequest,0,networkIdRequest.length,2e3,"255.255.255.255")}function start(){function doDiscover(){request(),removeOutdatedDiyas(),"started"===state&&setTimeout(doDiscover,1e3)}isNode()&&(state="started",socket||(socket=dgram.createSocket("udp4"),socket.on("message",function(data,rinfo){var msg=data.toString("ascii"),params=msg.split(":");2==params.length&&gotDiya(params[0],params[1],rinfo.address)}),socket.on("listening",function(){socket.setBroadcast(!0)})),doDiscover())}function stop(){for(state="stopped",socket&&socket.close();callbacks.length;)callbacks.pop()}function availableDiyas(){return diyas}var dgram,socket,networkIdRequest="diya-network-id\n",callbacks=[],diyas=[],state="stopped";module.exports={start:start,stop:stop,listen:listen,isDiscoverable:isNode,availableDiyas:availableDiyas}},{}],7:[function(require,module,exports){function Message(service,func,obj,permanent){this.service=service,this.func=func,this.obj=obj,this.permanent=permanent}Message.buildSignature=function(msg){return msg.service+"."+msg.func+"."+msg.obj},Message.prototype.signature=function(){return this.service+"."+this.func+"."+this.obj},Message.prototype.exec=function(data){return{service:this.service,func:this.func,obj:this.obj,data:data}},module.exports=Message},{}],8:[function(require,module,exports){function Promethe(session){var that=this;this.rtc=new RTC.RTC(session),this.rtc.onclose=function(){"function"==typeof that.onclose&&that.onclose()}}var RTC=require("../rtc/rtc");Promethe.prototype.use=function(regex,callback){var that=this;this.rtc.use(regex,function(channel){that._negociateNeuron(channel,callback)})},Promethe.prototype.connect=function(){this.rtc.connect()},Promethe.prototype.disconnect=function(){this.rtc.disconnect()},Promethe.prototype._negociateNeuron=function(channel,callback){channel.setOnMessage(function(message){var view=new DataView(message.data),typeChar=String.fromCharCode(view.getUint8(0));"O"===typeChar?channel.type="input":"I"===typeChar&&(channel.type="output");var size=view.getInt32(1,!0);void 0!=size&&(channel.size=size,channel._buffer=new Float32Array(size)),channel.setOnMessage(void 0),channel.setOnValue=function(onvalue_cb){channel.setOnMessage(onvalue_cb)},channel.write=function(index,value){return 0>index||index>channel.size||isNaN(value)?!1:(channel._buffer[index]=value,!0)},channel.frequency=33,channel._run=function(){channel.send(channel._buffer)&&setTimeout(channel._run,channel.frequency)},channel._run(),callback(channel)})},module.exports=Promethe},{"../rtc/rtc":10}],9:[function(require,module,exports){function QEI(node,callback,sampling){var that=this;return this.node=node,this.sampling=sampling||10,this.callback=callback||function(res){},node.get({service:"qei",func:"DataRequest",data:{type:"msgInit",sampling:1,requestedData:"all"}},function(data){that.dataModel={},that._getDataModelFromRecv(data),that._updateLevels(that.dataModel),that.callback(that.dataModel),node.listen({service:"qei",func:"SubscribeQei"},function(res){that._getDataModelFromRecv(res.data),that._updateLevels(that.dataModel),that.callback(that.dataModel)})}),console.log("DiyaSDK - QEI: created"),this}require("util"),require("../message");QEI.prototype.getDataModel=function(){return this.dataModel},QEI.prototype.getDataRange=function(){return this.dataModel.range},QEI.prototype.updateQualityIndex=function(){var dm=this.dataModel;for(var d in dm)"time"!=d&&dm[d].data&&(dm[d].qualityIndex&&dm[d].data.length==dm[d].qualityIndex.length||(dm[d].qualityIndex=new Array(dm[d].data.length)),dm[d].data.forEach(function(v,i){dm[d].qualityIndex[i]=checkQuality(v,dm[d].qualityConfig)}))},QEI.prototype.getDataconfortRange=function(){return this.dataModel.confortRange},QEI.prototype.getSampling=function(numSamples){return this.sampling},QEI.prototype.setSampling=function(numSamples){this.sampling=numSamples},QEI.prototype._updateConfinementLevel=function(model){var co2=model.CO2.data[model.CO2.data.length-1],voct=model.VOCt.data[model.VOCt.data.length-1],confinement=Math.max(co2,voct);return 800>confinement?3:1600>confinement?2:2400>confinement?1:3e3>confinement?0:void 0},QEI.prototype._updateAirQualityLevel=function(confinement,model){var fineDustQualityIndex=model["Fine Dust"].qualityIndex[model["Fine Dust"].qualityIndex.length-1],ozoneQualityIndex=model.Ozone.qualityIndex[model.Ozone.qualityIndex.length-1],qualityIndex=fineDustQualityIndex+ozoneQualityIndex;return 2>qualityIndex?confinement-1:confinement},QEI.prototype._updateEnvQualityLevel=function(airQuality,model){var humidityQualityIndex=model.Humidity.qualityIndex[model.Humidity.qualityIndex.length-1],temperatureQualityIndex=model.Temperature.qualityIndex[model.Temperature.qualityIndex.length-1],qualityIndex=humidityQualityIndex+temperatureQualityIndex;return 2>qualityIndex?airQuality-1:airQuality},QEI.prototype._updateLevels=function(model){this.confinement=this._updateConfinementLevel(model),this.airQuality=this._updateAirQualityLevel(this.confinement,model),this.envQuality=this._updateEnvQualityLevel(this.airQuality,model)},QEI.prototype.getConfinementLevel=function(){return this.confinement},QEI.prototype.getAirQualityLevel=function(){return this.airQuality},QEI.prototype.getEnvQualityLevel=function(){return this.envQuality};var checkQuality=function(data,qualityConfig){var quality;return data&&qualityConfig?quality=data>qualityConfig.confortRange[1]||data<qualityConfig.confortRange[0]?0:1:1};QEI.prototype._getDataModelFromRecv=function(data){var dataModel=this.dataModel;if(b64ToUint6=function(nChr){return nChr>64&&91>nChr?nChr-65:nChr>96&&123>nChr?nChr-71:nChr>47&&58>nChr?nChr+4:43===nChr?62:47===nChr?63:0},base64DecToArr=function(sBase64,nBlocksSize){for(var nMod3,nMod4,sB64Enc=sBase64.replace(/[^A-Za-z0-9\+\/]/g,""),nInLen=sB64Enc.length,nOutLen=nBlocksSize?Math.ceil((3*nInLen+1>>2)/nBlocksSize)*nBlocksSize:3*nInLen+1>>2,buffer=new ArrayBuffer(nOutLen),taBytes=new Uint8Array(buffer),nUint24=0,nOutIdx=0,nInIdx=0;nInLen>nInIdx;nInIdx++)if(nMod4=3&nInIdx,nUint24|=b64ToUint6(sB64Enc.charCodeAt(nInIdx))<<18-6*nMod4,3===nMod4||nInLen-nInIdx===1){for(nMod3=0;3>nMod3&&nOutLen>nOutIdx;nMod3++,nOutIdx++)taBytes[nOutIdx]=nUint24>>>(16>>>nMod3&24)&255;nUint24=0}return buffer},data&&data.header){if(1==data.header.sampling){data.header.timeEnd&&(dataModel.time||(dataModel.time=[]),dataModel.time.push(data.header.timeEnd),dataModel.time.length>this.sampling&&(dataModel.time=dataModel.time.slice(dataModel.time.length-this.sampling)));for(var n in data)if("header"!=n&&"time"!=n){if(dataModel[n]||(dataModel[n]={},dataModel[n].data=[]),dataModel[n].range=data[n].range,dataModel[n].label=data[n].label,dataModel[n].unit=data[n].unit,dataModel[n].qualityConfig={confortRange:data[n].confortRange},data[n].data.length>0){var buf=base64DecToArr(data[n].data,4),fArray=new Float32Array(buf);data[n].size!=fArray.length&&console.log("Mismatch of size "+data[n].size+" vs "+fArray.length),1!=data[n].size&&console.log("Expected 1 value received :"+data[n].size),dataModel[n].data||(dataModel[n].data=[]),dataModel[n].data.push(fArray[0]),dataModel[n].data.length>this.sampling&&(dataModel[n].data=dataModel[n].data.slice(dataModel[n].data.length-this.sampling))}else 0!=data[n].size&&console.log("Size mismatch received data (no data versus size="+data[n].size+")"),dataModel[n].data=[];this.updateQualityIndex()}}else for(var n in data)if("time"==n);else if("header"!=n)if(dataModel[n]||(dataModel[n]={},dataModel[n].data=[]),dataModel[n].range=data[n].range,dataModel[n].label=data[n].label,dataModel[n].unit=data[n].unit,dataModel[n].qualityConfig={confortRange:data[n].confortRange},data[n].data.length>0){var buf=base64DecToArr(data[n].data,4),fArray=new Float32Array(buf);data[n].size!=fArray.length&&console.log("Mismatch of size "+data[n].size+" vs "+fArray.length),fArray.length>dataModel[n].data.length&&(dataModel[n].data=new Array(dataModel[n].size));for(var i in fArray)dataModel[n].data[parseInt(i)]=fArray[i]}else 0!=data[n].size&&console.log("Size mismatch received data (no data versus size="+data[n].size+")"),dataModel[n].data=[]}else console.log("No Data to read or header is missing !");return this.dataModel};var exp={QEI:QEI};module.exports=exp},{"../message":7,util:4}],10:[function(require,module,exports){function Channel(name,open_cb){this.name=name,this.channel=void 0,this.onopen=open_cb,this.closed=!1}function Peer(rtc,id,channels){this.id=id,this.channels=channels,this.rtc=rtc,this.peer=null,this.connected=!1,this.closed=!1,this._connect()}function RTC(node){this.node=node,this.usedChannels=[],this.requestedChannels=[],this.peers=[]}var RTCPeerConnection=(require("util"),require("../message"),window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection),RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate,RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription;Channel.prototype.setChannel=function(datachannel){this.channel=datachannel;var that=this;that.onopen&&that.onopen(that)},Channel.prototype.close=function(){this.closed=!0},Channel.prototype.setOnMessage=function(onmessage){this.channel.onmessage=onmessage},Channel.prototype.send=function(msg){if(this.closed)return!1;if("open"===this.channel.readyState){try{this.channel.send(msg)}catch(e){console.log("[rtc.channel.write] exception occured while sending data")}return!0}return console.log("[rtc.channel.write] warning : webrtc datachannel state = "+this.channel.readyState),!1},Peer.prototype._connect=function(){var that=this;this.sub=this.rtc.node.listen({service:"rtc",func:"Connect",obj:this.channels,data:{promID:this.id}},function(data){that._handleNegociationMessage(data)}),setTimeout(function(){that.connected||that.closed||that.rtc.reconnect()},1e4)},Peer.prototype._handleNegociationMessage=function(msg){"RemoteOffer"===msg.eventType?this._createPeer(msg):"RemoteICECandidate"===msg.eventType&&this._addRemoteICECandidate(msg)};var servers={iceServers:[{url:"stun:stun.l.google.com:19302"}]};Peer.prototype._createPeer=function(data){var that=this,peer=new RTCPeerConnection(servers,{mandatory:[{DtlsSrtpKeyAgreement:!0},{EnableDtlsSrtp:!0}]});this.peer=peer,peer.setRemoteDescription(new RTCSessionDescription({sdp:data.sdp,type:data.type})),peer.createAnswer(function(session_description){peer.setLocalDescription(session_description),that.rtc.node.get({service:"rtc",func:"Answer",data:{promID:data.promID,peerId:data.peerId,sdp:session_description.sdp,type:session_description.type}})},function(err){console.log("cannot create answer")},{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}),peer.oniceconnectionstatechange=function(){console.log(peer.iceConnectionState),"connected"===peer.iceConnectionState?(that.connected=!0,that.rtc.node.stopListening(this.sub)):"disconnected"===peer.iceConnectionState&&(that.closed||that.rtc.reconnect())},peer.onicecandidate=function(evt){that.rtc.node.get({service:"rtc",func:"ICECandidate",data:{peerId:data.peerId,promID:that.id,candidate:evt.candidate}})},peer.ondatachannel=function(evt){that.connected=!0,that.rtc._onDataChannel(evt.channel)}},Peer.prototype._addRemoteICECandidate=function(data){var that=this;try{var candidate=new RTCIceCandidate(data.candidate);this.peer.addIceCandidate(candidate,function(){console.log("candidate added ("+that.peer.iceConnectionState+")")},function(e){console.log(e)})}catch(e){console.log(e)}},Peer.prototype.close=function(){if(this.rtc.node.stopListening(this.sub),this.peer)try{this.peer.close()}catch(e){}this.connected=!1,this.closed=!0},RTC.prototype.use=function(name_regex,onopen_callback){this.requestedChannels.push({regex:name_regex,cb:onopen_callback})},RTC.prototype.reconnect=function(){var that=this;that.disconnect(),that.connect(),console.log("reconnecting...")},RTC.prototype.disconnect=function(){for(var promID in this.peers)this._closePeer(promID);this.node.stopListening(this.sub),"function"==typeof this.onclose&&this.onclose()},RTC.prototype.connect=function(){var that=this;this.sub=this.node.listen({service:"rtc",func:"ListenPeers"},function(data){if(data.eventType&&void 0!==data.promID)if("PeerConnected"===data.eventType){if(!that.peers[data.promID]){var channels=that._matchChannels(data.channels);channels.length>0&&(that.peers[data.promID]=new Peer(that,data.promID,channels))}}else"PeerClosed"===data.eventType&&(that.peers[data.promID]&&that._closePeer(data.promID),"function"==typeof that.onclose&&that.onclose())})},RTC.prototype._closePeer=function(promID){if(this.peers[promID]){var p=this.peers[promID];p.close();for(var i=0;i<p.channels.length;i++)delete this.usedChannels[p.channels[i]];delete this.peers[promID]}},RTC.prototype._matchChannels=function(receivedChannels){for(var that=this,channels=[],i=0;i<receivedChannels.length;i++)for(var name=receivedChannels[i],j=0;j<that.requestedChannels.length;j++){var req=that.requestedChannels[j];name&&name.match(req.regex)&&!that.usedChannels[name]&&(that.usedChannels[name]=new Channel(name,req.cb),channels.push(name))}return channels},RTC.prototype._onDataChannel=function(datachannel){console.log("Channel "+datachannel.label+" created !");var channel=this.usedChannels[datachannel.label];return channel?void channel.setChannel(datachannel):void datachannel.close()};var exp={RTC:RTC};module.exports=exp},{"../message":7,util:4}],11:[function(require,module,exports){function Update(node){return this.node=node,this}require("util"),require("../message");Update.prototype.listPackages=function(callback){this.node.get({service:"update",func:"ListPackages"},function(data){data.packages&&callback(null,data.packages),data.error&&callback(data.error,null)})},Update.prototype.updateAll=function(callback){this.node.get({service:"update",func:"UpdateAll"},function(data){data.packages&&callback(null,data.packages),data.error&&callback(data.error,null)})},Update.prototype.installPackage=function(pkg,callback){if("Undefined"===pkg||"string"!=typeof pkg||pkg.length<2)callback("undefinedPackage",null);else{var INVALID_PARAMETERS_REGEX=/^-|[^\s]\s+[^\s]|-$/,testNamePkg=INVALID_PARAMETERS_REGEX.test(pkg);testNamePkg?callback("InvalidParameters",null):this.node.get({service:"update",func:"InstallPackage",data:{"package":pkg}},function(data){data.packages&&callback(null,data.packages),data.error&&callback(data.error,null)})}};var exp={Update:Update};module.exports=exp},{"../message":7,util:4}]},{},[5])(5)});