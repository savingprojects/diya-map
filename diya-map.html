<link rel="import" href="bower_components/polymer/polymer.html">
<script src="bower_components/d3/d3.min.js"></script>

<polymer-element name="diya-map">
	<template>
		<style type="text/css">
			:host{
				display: block;
			}

			svg{
				width: 100%;
				height: 100%;
			}

			#places{
				fill: black;
			}
		</style>
		
		<svg id="map" version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
			<g id="mapContent" x="10" y="10">
				<image width="100%" height="100%" x="0" y="0" xlink:href="defaultMap.svg" />

				<g id="places">
					
				</g>
			<g>
		</svg>

	</template>

	<script type="text/javascript">
	Polymer({
		ready: function(){
			var that = this;

			this.initMapNavigation();
			this.initDragPlaceBehavior();

			this.places = [{x: 150, y: 100, r: 10}, {x: 10, y: 100, r: 10}, {x: 250, y: 100, r: 10}];
			this.updatePlaces();

			setTimeout(function(){
				that.addPlace();
			}, 3000);
		},

		addPlace: function(){
			this.places.push({x: 300, y: 300, r: 10});
			this.updatePlaces();
		},

		updatePlaces: function(){
			var placeElements = d3.select(this.$.places)
			  .selectAll('.place')
			  .data(this.places);
			
			placeElements.enter()
			  .append('svg:circle')
			  .attr('class', 'place')
			  .attr('cx', function(d) { return d.x; })
			  .attr('cy', function(d) { return d.y; })
			  .attr('r', function(d) { return d.r; })
			  .call(this.dragPlaceBehavior)

			placeElements.exit().remove();
		},

		initDragPlaceBehavior: function(){
			
			//Drag n Drop for Places
			this.dragPlaceBehavior = d3.behavior.drag()
				.on('dragstart', function(){

					d3.event.sourceEvent.stopPropagation();

					d3.select(this)
					  .transition()
					  .attr('r', 20)
				})
				.on('drag', function(){
					d3.select(this)
					  .attr('cx', d3.event.x)
					  .attr('cy', d3.event.y)
				})
				.on('dragend', function(){
					d3.select(this)
					  .transition()
					  .attr('r', 10)
				});
		},

		//Init map translation and zoom
		initMapNavigation: function(){
			var that = this;

			//Drag n Drop for the whole map
			this.$.mapContent.x = 0;
			this.$.mapContent.y = 0;

			this.$.mapContent.tx = 0;
			this.$.mapContent.ty = 0;

			this.$.mapContent.scale = 1;

			function updateTransformation(){

				var x = that.$.mapContent.x+that.$.mapContent.tx;
				var y = that.$.mapContent.y+that.$.mapContent.ty;

				d3.select(that.$.mapContent)
					.attr('transform', 'translate('+x+','+y+'), scale('+that.$.mapContent.scale+')');
			}

			this.dragMapBehavior = d3.behavior.drag()
				.on('dragstart', function(){
					d3.event.sourceEvent.stopPropagation();
				})
				.on('drag', function(){

					this.x = this.x + d3.event.dx;
					this.y = this.y + d3.event.dy;				  
					  
					updateTransformation();
				})

			d3.select(this.$.mapContent)
			  .call(this.dragMapBehavior);

			//zoom in/out for the whole map
			this.zoomMapBehavior = d3.behavior.zoom()
				.on('zoom', function(){
					that.$.mapContent.tx = d3.event.translate[0];
					that.$.mapContent.ty = d3.event.translate[1];
					that.$.mapContent.scale = d3.event.scale;
					updateTransformation();
				})

			d3.select(this.$.map)
				.call(this.zoomMapBehavior);
		}


	});
	</script>

</polymer-element>